<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Processos e Procedimentos - Sistema de Gestão</title>
    <link rel="icon" type="image/x-icon" href="static/images/SJD-GESTOR.ico">
    <script type="text/javascript" src="/eel.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/css/dashboard.css">
    <link rel="stylesheet" href="static/css/users.css">
    <link rel="stylesheet" href="static/css/procedures.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-dashboard">
                <img src="static/images/bpm.png" alt="7º BPM" class="logo-image">
                <h1>Seção de Justiça e Disciplina - 7ºBPM</h1>
            </div>
            
            <div class="user-info">
                <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="user-details">
                        <h3 id="userName">Carregando...</h3>
                        <p id="userEmail">usuário</p>
                    </div>
                </div>
                
                <button class="btn-logout" onclick="realizarLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div id="alertContainer"></div>
        
        <div class="user-management">
            <div class="page-header">
                <!-- <h1 class="page-title">
                    <i class="fas fa-folder-open page-icon"></i>
                    Gerenciar Procedimentos
                </h1> -->
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-folder-open"></i>
                    <h2>Lista de Processos e Procedimentos</h2>
                </div>
                
                <div class="actions">
                    <!-- Área de Busca Simples -->
                    <div class="search-area">
                        <input type="text" id="searchInput" placeholder="Busca rápida por qualquer campo...">
                        <button onclick="limparBusca()" id="clearButton" class="btn-icon btn-clear" style="display: none;"><i class="fas fa-times"></i> Limpar</button>
                        <button onclick="abrirModalFiltros()" id="filterToggle" class="btn-icon btn-filter"><i class="fas fa-filter"></i> Filtros</button>
                    </div>
                    
                    <!-- Área de Ações -->
                    <div class="main-actions">
                        <button onclick="window.location.href='procedure_form.html'" class="btn-icon btn-new"><i class="fas fa-plus"></i> Novo Registro</button>
                        <button onclick="window.location.href='dashboard.html'" class="btn-icon btn-home"><i class="fas fa-home"></i> Início</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th width="7%" style="text-align:center;">Tipo</th>
                                <th width="5%" style="text-align:center;">Ano</th>
                                <th width="6%" style="text-align:center;">Número</th>
                                <th width="8%" style="text-align:center;">Origem</th>
                                <th width="10%" style="text-align:center;">SEI</th>
                                <th width="20%" style="text-align:center;">Encarregado</th>
                                <th width="26%" style="text-align:center;">PM Envolvido</th>
                                <th width="15%" style="text-align:center;">Status Prazo</th>
                                <th width="3%" style="text-align:center;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="procedureTableBody">
                            <!-- Os procedimentos serão carregados aqui -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Controles de Paginação -->
                <div class="pagination-controls">
                    <button id="prevPage" class="btn-pagination" disabled><i class="fas fa-chevron-left"></i> Anterior</button>
                    <span id="pageInfo">Página 1 de 1</span>
                    <button id="nextPage" class="btn-pagination" disabled>Próxima <i class="fas fa-chevron-right"></i></button>
                </div>
                
                <div class="empty-state" id="emptyState" style="display: none;">
                    <i class="fas fa-folder-open"></i>
                    <h3>Nenhum procedimento encontrado</h3>
                    <p>Não há processos ou procedimentos cadastrados ou sua pesquisa não encontrou resultados.</p>
                </div>

                <!-- Loader -->
                <div class="loader-container" id="loaderContainer" style="display: none;">
                    <div class="loader">
                        <div class="cell d-0"></div>
                        <div class="cell d-1"></div>
                        <div class="cell d-2"></div>
                        <div class="cell d-1"></div>
                        <div class="cell d-2"></div>
                        <div class="cell d-2"></div>
                        <div class="cell d-3"></div>
                        <div class="cell d-3"></div>
                        <div class="cell d-4"></div>
                    </div>
                    <p style="margin-top: 20px; color: #666; text-align: center;">Carregando processos e procedimentos...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmModal" class="modal-feedback">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Confirmar Ação</h3>
            </div>
            <div class="modal-body">
                <p id="modalMessage">Tem certeza que deseja realizar esta ação?</p>
            </div>
            <div class="modal-actions">
                <button id="confirmBtn" class="btn-primary">Confirmar</button>
                <button id="cancelBtn" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Estilos adicionais específicos para procedimentos -->
    <style>
        /* Centralizar os botões de ação */
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            margin: 30px auto 20px auto;
            padding: 0 20px;
        }
        
        /* Garantir que search-area e main-actions tenham a mesma altura base */
        .search-area,
        .main-actions {
            align-items: center;
            min-height: 44px;
        }

        /* Sobrescrever estilos específicos se necessário */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #dee2e6;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #495057;
        }

        .empty-state p {
            font-size: 1rem;
            color: #6c757d;
        }

        /* Ajustes específicos para campo de busca de procedimentos */
        #searchInput {
            max-width: 400px !important;
            min-width: 350px;
        }

        @media (max-width: 768px) {
            #searchInput {
                min-width: 250px;
                max-width: 100% !important;
            }
            
            .actions {
                padding: 0 10px;
            }
        }

        @media (max-width: 480px) {
            #searchInput {
                min-width: 100%;
            }
            
            .actions {
                flex-direction: column;
                padding: 0;
            }
            
            .btn-icon {
                width: 100%;
                justify-content: center;
            }
        }

        /* Loader styles */
        .loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            min-height: 300px;
        }

        .loader {
            --cell-size: 52px;
            --cell-spacing: 1px;
            --cells: 3;
            --total-size: calc(var(--cells) * (var(--cell-size) + 2 * var(--cell-spacing)));
            display: flex;
            flex-wrap: wrap;
            width: var(--total-size);
            height: var(--total-size);
        }

        .cell {
            flex: 0 0 var(--cell-size);
            margin: var(--cell-spacing);
            background-color: transparent;
            box-sizing: border-box;
            border-radius: 4px;
            animation: 1.5s ripple ease infinite;
        }

        .cell.d-1 {
            animation-delay: 100ms;
        }

        .cell.d-2 {
            animation-delay: 200ms;
        }

        .cell.d-3 {
            animation-delay: 300ms;
        }

        .cell.d-4 {
            animation-delay: 400ms;
        }

        .cell:nth-child(1) {
            --cell-color: #00FF87;
        }

        .cell:nth-child(2) {
            --cell-color: #0CFD95;
        }

        .cell:nth-child(3) {
            --cell-color: #17FBA2;
        }

        .cell:nth-child(4) {
            --cell-color: #23F9B2;
        }

        .cell:nth-child(5) {
            --cell-color: #30F7C3;
        }

        .cell:nth-child(6) {
            --cell-color: #3DF5D4;
        }

        .cell:nth-child(7) {
            --cell-color: #45F4DE;
        }

        .cell:nth-child(8) {
            --cell-color: #53F1F0;
        }

        .cell:nth-child(9) {
            --cell-color: #60EFFF;
        }

        @keyframes ripple {
            0% {
                background-color: transparent;
            }
            30% {
                background-color: var(--cell-color);
            }
            60% {
                background-color: transparent;
            }
            100% {
                background-color: transparent;
            }
        }

        /* Modal simples para visualizar PDFs */
        .modal-pdf-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.75);
            z-index: 9999;
            padding: 20px;
        }

        .modal-pdf-container {
            width: 100%;
            max-width: 900px;
            max-height: 95vh;
            background: #fff;
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.35);
            overflow: hidden;
        }

        .modal-pdf-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(120deg, #233554 0%, #1f2a44 100%);
            color: #fff;
        }

        .modal-pdf-titulo {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .modal-pdf-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-pdf-action,
        .btn-pdf-close {
            background: rgba(255, 255, 255, 0.12);
            border: none;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 0.95rem;
        }

        .btn-pdf-action:hover,
        .btn-pdf-close:hover {
            background: rgba(255, 255, 255, 0.22);
        }

        .modal-pdf-body {
            position: relative;
            flex: 1;
            background: #111;
        }

        .pdf-iframe {
            width: 100%;
            height: 80vh;
            border: none;
        }

        .pdf-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: #f1f5f9;
        }

        .pdf-loading.hidden {
            display: none;
        }

        .pdf-spinner {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.15);
            border-top-color: #4dabf7;
            animation: pdf-spinner 0.9s linear infinite;
        }

        @keyframes pdf-spinner {
            to {
                transform: rotate(360deg);
            }
        }

        .modal-processo-pdf-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(17, 24, 39, 0.78);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            padding: 20px;
        }

        .modal-processo-pdf {
            width: 100%;
            max-width: 520px;
            background: #ffffff;
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 24px 48px rgba(15, 23, 42, 0.35);
            position: relative;
        }

        .modal-processo-pdf-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 22px;
            background: linear-gradient(135deg, #1f2d3d 0%, #243b53 100%);
            color: #ffffff;
        }

        .modal-processo-pdf-header h3 {
            margin: 0;
            font-size: 1.15rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-processo-pdf-close {
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 1.8rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-processo-pdf-body {
            padding: 22px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .modal-processo-pdf-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .modal-processo-pdf-info .info-label {
            text-transform: uppercase;
            font-size: 0.78rem;
            letter-spacing: 0.05em;
            color: #64748b;
        }

        .modal-processo-pdf-info .info-value {
            font-size: 1.05rem;
            font-weight: 600;
            color: #0f172a;
        }

        .modal-processo-pdf-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px 18px;
            background: #f8fafc;
        }

        .pdf-info-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            font-size: 0.95rem;
            color: #1f2937;
            line-height: 1.4;
        }

        .pdf-info-row strong {
            color: #334155;
        }

        .pdf-info-empty,
        .pdf-info-loading {
            margin: 0;
            font-size: 0.95rem;
            color: #64748b;
            text-align: center;
        }

        .modal-processo-pdf-actions {
            display: flex;
            gap: 12px;
        }

        .modal-processo-pdf-actions button {
            flex: 1;
        }

        .pdf-upload-label {
            display: block;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }

        #inputPdfArquivo {
            width: 100%;
            padding: 10px 12px;
            border: 1px dashed #94a3b8;
            border-radius: 8px;
            background: #ffffff;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        #inputPdfArquivo:hover {
            border-color: #2563eb;
        }

        .pdf-upload-hint {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #64748b;
        }

        .modal-processo-pdf-footer {
            display: flex;
            gap: 14px;
            padding: 18px 22px;
            background: #f1f5f9;
        }

        .btn-pdf-primary,
        .btn-pdf-secondary,
        .btn-pdf-danger,
        .btn-pdf-cancelar {
            flex: 1;
            border: none;
            border-radius: 10px;
            padding: 11px 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .btn-pdf-primary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #ffffff;
        }

        .btn-pdf-primary:not(:disabled):hover {
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.24);
            transform: translateY(-1px);
        }

        .btn-pdf-primary:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-pdf-secondary {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            color: #1f2937;
        }

        .btn-pdf-secondary:disabled {
            border-color: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .btn-pdf-secondary:not(:disabled):hover {
            background: #e2e8f0;
        }

        .btn-pdf-danger {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #b91c1c;
        }

        .btn-pdf-danger:disabled {
            background: #fef2f2;
            border-color: #fef2f2;
            color: #d4d4d8;
            cursor: not-allowed;
        }

        .btn-pdf-danger:not(:disabled):hover {
            background: #fecaca;
        }

        .btn-pdf-cancelar {
            background: #e2e8f0;
            color: #1f2937;
        }

        .btn-pdf-cancelar:hover {
            background: #cbd5f5;
        }

        .modal-processo-pdf-loader {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .modal-processo-pdf-loader.show {
            display: flex;
        }

        .modal-processo-pdf-loader .loader-content {
            background: rgba(15, 23, 42, 0.92);
            color: #e2e8f0;
            padding: 18px 28px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            box-shadow: 0 18px 36px rgba(15, 23, 42, 0.45);
        }

        .modal-processo-pdf-loader .loader-ring {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 4px solid rgba(148, 163, 184, 0.35);
            border-top-color: #38bdf8;
            animation: pdf-spinner 0.85s linear infinite;
        }
    </style>

    <!-- Modal de Filtros -->
    <div id="modalFiltros" class="modal-filtros" style="display: none;">
        <div class="modal-content-filtros">
            <div class="modal-header-filtros">
                <h3><i class="fas fa-filter"></i> Filtros Avançados</h3>
                <button type="button" class="btn-close-modal" onclick="fecharModalFiltros()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body-filtros">
                <div class="filtros-grid-modal">
                    <div class="filter-group-modal">
                        <label for="filtroTipo">Tipo:</label>
                        <select id="filtroTipo" class="filter-select-modal">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    
                    <div class="filter-group-modal">
                        <label for="filtroAno">Ano:</label>
                        <select id="filtroAno" class="filter-select-modal">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    
                    <div class="filter-group-modal">
                        <label for="filtroOrigem">Unidade:</label>
                        <select id="filtroOrigem" class="filter-select-modal">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    
                    <div class="filter-group-modal">
                        <label for="filtroLocalFatos">Local dos Fatos:</label>
                        <select id="filtroLocalFatos" class="filter-select-modal">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    
                    <div class="filter-group-modal">
                        <label for="filtroEncarregado">Encarregado:</label>
                        <input list="listaEncarregados" id="filtroEncarregado" class="filter-input-modal" placeholder="Digite ou selecione um encarregado...">
                        <datalist id="listaEncarregados">
                            <option value="">Todos</option>
                        </datalist>
                    </div>
                    
                    
                    <div class="filter-group-modal">
                        <label for="filtroPmEnvolvido">PM Envolvido:</label>
                        <input list="listaPmEnvolvidos" id="filtroPmEnvolvido" class="filter-input-modal" placeholder="Digite ou selecione um PM...">
                        <datalist id="listaPmEnvolvidos">
                            <option value="">Todos</option>
                        </datalist>
                    </div>
                    
                    <div class="filter-group-modal">
                        <label for="filtroVitima">Vítima/Ofendido:</label>
                        <input list="listaVitimas" id="filtroVitima" class="filter-input-modal" placeholder="Digite ou selecione uma vítima...">
                        <datalist id="listaVitimas">
                            <option value="">Todos</option>
                        </datalist>
                    </div>
                    
                    <div class="filter-group-modal">
                        <label for="filtroDocumento">Documento:</label>
                        <select id="filtroDocumento" class="filter-select-modal">
                            <option value="">Todos</option>
                            <option value="Portaria">Portaria</option>
                            <option value="Memorando Disciplinar">Memorando Disciplinar</option>
                            <option value="Feito Preliminar">Feito Preliminar</option>
                        </select>
                    </div>
                    
                    <div class="filter-group-modal">
                        <label for="filtroSituacao">Situação:</label>
                        <select id="filtroSituacao" class="filter-select-modal">
                            <option value="">Todas</option>
                            <option value="concluido">Concluído</option>
                            <option value="em_andamento">Em andamento (todos)</option>
                            <option value="em_andamento_no_prazo">Em andamento no prazo</option>
                            <option value="em_andamento_vencido">Em andamento vencido</option>
                        </select>
                    </div>
                    
                    <div class="filter-group-modal">
                        <label for="filtroDataInicio">Data Instauração (Início):</label>
                        <input type="date" id="filtroDataInicio" class="filter-input-modal">
                    </div>
                    
                    <div class="filter-group-modal">
                        <label for="filtroDataFim">Data Instauração (Fim):</label>
                        <input type="date" id="filtroDataFim" class="filter-input-modal">
                    </div>
                </div>
            </div>
            
            <div class="modal-footer-filtros">
                <button type="button" class="btn btn-primary" onclick="aplicarFiltrosModal()">
                    <i class="fas fa-check"></i> Aplicar Filtros
                </button>
                <button type="button" class="btn btn-secondary" onclick="limparFiltrosModal()">
                    <i class="fas fa-eraser"></i> Limpar Filtros
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="fecharModalFiltros()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Loader global para transições (logout) -->
    <div id="globalLoader" class="global-loader hidden" aria-hidden="true">
        <div class="spinner"></div>
    </div>

    <!-- Modal de Visualização de PDF -->
    <div id="modalPDFViewer" class="modal-pdf-overlay" style="display: none;">
        <div class="modal-pdf-container">
            <div class="modal-pdf-header">
                <h4 id="modalPDFTitulo" class="modal-pdf-titulo">
                    <i class="fas fa-file-pdf"></i>
                    Visualizador de PDF
                </h4>
                <div class="modal-pdf-actions">
                    <button id="btnDownloadPDF" class="btn-pdf-action" title="Fazer download">
                        <i class="fas fa-download"></i>
                    </button>
                    <button id="btnFecharModalPDF" class="btn-pdf-close" title="Fechar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-pdf-body">
                <iframe id="iframePDF" class="pdf-iframe" frameborder="0"></iframe>
                <div id="loadingPDF" class="pdf-loading hidden">
                    <div class="pdf-spinner"></div>
                    <p>Carregando PDF...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="static/js/permissions.js"></script>
    <script src="static/js/procedure_list.js"></script>
</body>
</html>