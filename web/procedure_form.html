<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Procedimento - Sistema de Gestão</title>
    <script type="text/javascript" src="/eel.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/css/dashboard.css">
    <link rel="stylesheet" href="static/css/users.css">
    <link rel="stylesheet" href="static/css/processes.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-dashboard">
                <img src="static/images/bpm.png" alt="7º BPM" class="logo-image">
                <h1>Seção de Justiça e Disciplina - 7ºBPM</h1>
            </div>
            
            <div class="user-info">
                <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="user-details">
                        <h3 id="userName">Carregando...</h3>
                        <p id="userEmail">usuário</p>
                    </div>
                </div>
                
                <button class="btn-logout" onclick="realizarLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div id="alertContainer"></div>
        
        <div class="container">
        
        <div class="form-section">
            <h2>Novo Registro</h2>
            <form id="processForm">
                <!-- Tipo de Cadastro -->
                <div class="form-group">
                    <label for="tipo_geral">Tipo de Cadastro *</label>
                    <select id="tipo_geral" required>
                        <option value="">Selecione...</option>
                        <option value="processo">Processo</option>
                        <option value="procedimento">Procedimento</option>
                    </select>
                </div>

                <!-- Campo dependente: Tipo de Procedimento -->
                <div class="form-group" id="group_tipo_procedimento" style="display: none;">
                    <label for="tipo_procedimento">Tipo de Procedimento *</label>
                    <select id="tipo_procedimento" required>
                        <option value="">Selecione...</option>
                        <option value="SR">SR</option>
                        <option value="IPM">IPM</option>
                        <option value="FP">FP</option>
                        <option value="AO">AO</option>
                        <option value="SV">SV</option>
                        <option value="CP">CP</option>
                    </select>
                </div>

                <!-- Campo dependente: Tipo de Processo -->
                <div class="form-group" id="group_tipo_processo" style="display: none;">
                    <label for="tipo_processo">Tipo de Processo *</label>
                    <select id="tipo_processo" required>
                        <option value="">Selecione...</option>
                        <option value="PADS">PADS</option>
                        <option value="PAD">PAD</option>
                        <option value="PADE">PADE</option>
                        <option value="CJ">CJ</option>
                        <option value="CD">CD</option>
                    </select>
                </div>

                <!-- Documento que iniciou -->
                <div class="form-group">
                    <label for="documento_iniciador">Documento que iniciou *</label>
                    <select id="documento_iniciador" required>
                        <option value="">Selecione...</option>
                        <option value="Portaria">Portaria</option>
                        <option value="Memorando Disciplinar">Memorando Disciplinar</option>
                        <option value="Feito Preliminar">Feito Preliminar</option>
                    </select>
                </div>

                <!-- Campos dependentes do documento -->
                <div class="form-group" id="group_numero_portaria" style="display: none;">
                    <label for="numero_portaria">Número da Portaria *</label>
                    <input type="text" id="numero_portaria" required>
                </div>
                <div class="form-group" id="group_numero_memorando" style="display: none;">
                    <label for="numero_memorando">Número do Memorando Disciplinar *</label>
                    <input type="text" id="numero_memorando" required>
                </div>
                <div class="form-group" id="group_numero_feito" style="display: none;">
                    <label for="numero_feito">Número do Feito Preliminar *</label>
                    <input type="text" id="numero_feito" required>
                </div>

                <!-- Checkbox para número de controle diferente -->
                <div class="form-group" id="group_checkbox_controle" style="display: none;">
                    <div class="checkbox-container">
                        <input type="checkbox" id="numero_controle_diferente">
                        <label for="numero_controle_diferente" id="label_controle_diferente">
                            Número de controle é diferente do número da portaria
                        </label>
                    </div>
                </div>

                <!-- Campo de número de controle (condicional) -->
                <div class="form-group" id="group_numero_controle" style="display: none;">
                    <label for="numero_controle" id="label_numero_controle">Número de Controle *</label>
                    <input type="text" id="numero_controle" required>
                    <small class="form-help" id="help_numero_controle">Número de controle do IPM</small>
                </div>

                <!-- RGF e SEI -->
                <div class="form-group">
                    <label for="numero_rgf">Número do RGF (opcional)</label>
                    <input type="text" id="numero_rgf" placeholder="XX.XX.XXXX" maxlength="10">
                    <small class="form-help">Formato: 25.08.8415</small>
                </div>
                <div class="form-group">
                    <label for="processo_sei">Número do processo SEI (opcional)</label>
                    <input type="text" id="processo_sei" placeholder="XXXX.XXXXXX/XXXX-XX" maxlength="19">
                    <small class="form-help">Formato: 0021.033044/2025-34</small>
                </div>

                <!-- Unidade onde foi instaurado -->
                <div class="form-group">
                    <label for="local_origem">Unidade onde foi instaurado *</label>
                    <select id="local_origem" required>
                        <option value="">Selecione...</option>
                        <option value="1ºBPM">1ºBPM</option>
                        <option value="2ºBPM">2ºBPM</option>
                        <option value="3ºBPM">3ºBPM</option>
                        <option value="4ºBPM">4ºBPM</option>
                        <option value="5ºBPM">5ºBPM</option>
                        <option value="6ºBPM">6ºBPM</option>
                        <option value="7ºBPM">7ºBPM</option>
                        <option value="8ºBPM">8ºBPM</option>
                        <option value="9ºBPM">9ºBPM</option>
                        <option value="10ºBPM">10ºBPM</option>
                        <option value="11ºBPM">11ºBPM</option>
                        <option value="CIPO - BURITIS">CIPO - BURITIS</option>
                        <option value="BPCHOQUE">BPCHOQUE</option>
                        <option value="BOPE">BOPE</option>
                        <option value="BPTRAN">BPTRAN</option>
                        <option value="BPTAR">BPTAR</option>
                        <option value="BPFRON">BPFRON</option>
                        <option value="BAVOP">BAVOP</option>
                        <option value="BPA">BPA</option>
                        <option value="CORREGEPOM">CORREGEPOM</option>
                    </select>
                </div>

                <!-- Local onde ocorreram os fatos -->
                <div class="form-group">
                    <label for="local_fatos">Local onde ocorreram os fatos *</label>
                    <div style="position: relative;">
                        <input type="text" id="local_fatos" name="local_fatos" required style="width: 100%;" placeholder="Digite o município ou distrito..." autocomplete="off">
                        <div id="local_fatos_dropdown" class="dropdown-infracao" style="display: none;">
                            <!-- Opções serão carregadas via JavaScript -->
                        </div>
                    </div>
                    <small class="form-help">Município ou distrito onde os fatos ocorreram</small>
                </div>

                <!-- Datas -->
                <div class="form-group">
                    <label for="data_instauracao">Data da Instauração *</label>
                    <input type="date" id="data_instauracao" required>
                </div>
                <div class="form-group">
                    <label for="data_recebimento">Data de Recebimento pelo Encarregado *</label>
                    <input type="date" id="data_recebimento" required>
                </div>

                <!-- Encarregado -->
                <div class="form-group">
                    <label for="responsavel_nome">Encarregado *</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="responsavel_nome" name="responsavel_nome" readonly required style="flex:1; background:#f5f5f5; cursor:pointer;" placeholder="Selecione o encarregado...">
                        <input type="hidden" id="responsavel_id" name="responsavel_id">
                        <button type="button" id="btnBuscarEncarregado" class="btn-lupa" title="Buscar Encarregado" style="background: none; border: none; cursor: pointer;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Campo dependente: Escrivão (para IPM) -->
                <div class="form-group" id="group_escrivao" style="display: none;">
                    <label for="escrivao_nome">Nome do Escrivão *</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="escrivao_nome" name="escrivao_nome" readonly required style="flex:1; background:#f5f5f5; cursor:pointer;" placeholder="Selecione o escrivão...">
                        <input type="hidden" id="escrivao_id" name="escrivao_id">
                        <button type="button" id="btnBuscarEscrivao" class="btn-lupa" title="Buscar Escrivão" style="background: none; border: none; cursor: pointer;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Status do PM -->
                <div class="form-group">
                    <label for="status_pm">Status do PM Envolvido *</label>
                    <select id="status_pm" required>
                        <option value="">Selecione...</option>
                        <option value="Acusado">Acusado</option>
                        <option value="Sindicado">Sindicado</option>
                        <option value="Investigado">Investigado</option>
                        <option value="Indiciado">Indiciado</option>
                        <option value="Acidentado">Acidentado</option>
                    </select>
                </div>

                <!-- Campo dependente do status do PM -->
                <div class="form-group" id="group_nome_pm" style="display: none;">
                    <label for="nome_pm_nome" id="label_nome_pm">Nome do PM *</label>
                    
                    <!-- Campo principal (sempre visível quando o grupo estiver ativo) -->
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <input type="text" id="nome_pm_nome" name="nome_pm_nome" readonly required style="flex:1; background:#f5f5f5; cursor:pointer;" placeholder="Selecione o PM...">
                        <input type="hidden" id="nome_pm" name="nome_pm">
                        <button type="button" id="btnBuscarPm" class="btn-lupa" title="Buscar PM" style="background: none; border: none; cursor: pointer;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <!-- Lista de PMs adicionais (apenas para procedimentos) -->
                    <div id="pms_adicionais_container" style="display: none;">
                        <!-- PMs adicionais serão adicionados aqui dinamicamente -->
                    </div>
                    
                    <!-- Botão para adicionar mais PMs (apenas para procedimentos) -->
                    <div id="botao_adicionar_pm" style="display: none; margin-top: 10px;">
                        <button type="button" id="btnAdicionarMaisPm" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">
                            <i class="fas fa-plus"></i> Adicionar mais PM
                        </button>
                    </div>
                </div>

                <!-- Campo dependente: Nome da Vítima -->
                <div class="form-group" id="group_nome_vitima" style="display: none;">
                    <label for="nome_vitima">Nome da Vítima/Ofendido</label>
                    <input type="text" id="nome_vitima">
                </div>

                <!-- Campo de Infração (para PADS) -->
                <div class="form-group" id="group_infracao" style="display: none;">
                    <label for="infracao_search">Transgressões Praticadas *</label>
                    
                    <!-- Lista de transgressões selecionadas -->
                    <div id="transgressoes_selecionadas" class="transgressoes-container" style="display: none;">
                        <!-- Transgressões serão adicionadas aqui dinamicamente -->
                    </div>
                    
                    <!-- Campo de busca para nova transgressão -->
                    <div id="campo_busca_transgressao" style="position: relative;">
                        <!-- Seletor de tipo de infração -->
                        <div class="form-group mb-2">
                            <label for="tipo_infracao" style="font-size: 0.9rem; margin-bottom: 5px;">Tipo de Infração:</label>
                            <select id="tipo_infracao" class="form-control" style="font-size: 0.9rem;">
                                <option value="">Selecione o tipo...</option>
                                <option value="rdpm">RDPM (Regulamento Disciplinar da Polícia Militar)</option>
                                <option value="estatuto">Art. 29 do Decreto Lei 09-A (Estatuto)</option>
                            </select>
                        </div>
                        
                        <!-- Seletor de natureza da nova transgressão (só para RDPM) -->
                        <div id="grupo_natureza_rdpm" class="form-group mb-2" style="display: none;">
                            <label for="natureza_nova_transgressao" style="font-size: 0.9rem; margin-bottom: 5px;">Natureza da Transgressão:</label>
                            <select id="natureza_nova_transgressao" class="form-control" style="font-size: 0.9rem;">
                                <option value="">Selecione a natureza...</option>
                                <option value="Leve">Leve</option>
                                <option value="Média">Média</option>
                                <option value="Grave">Grave</option>
                            </select>
                        </div>
                        
                        <!-- Campo de busca para infrações -->
                        <input type="text" id="infracao_search" placeholder="Primeiro selecione o tipo de infração..." autocomplete="off" disabled>
                        <input type="hidden" id="transgressoes_ids" name="transgressoes_ids">
                        <div id="infracao_dropdown" class="dropdown-infracao" style="display: none;">
                            <!-- Opções serão carregadas via JavaScript -->
                        </div>
                        
                        <!-- Seleção de analogia RDPM (só para Art. 29) -->
                        <div id="grupo_analogia_rdpm" style="display: none; margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
                            <h6 style="color: #333; margin-bottom: 10px;">Analogia com RDPM:</h6>
                            <div class="form-group mb-2">
                                <label for="analogia_natureza" style="font-size: 0.9rem; margin-bottom: 5px;">Natureza da Analogia:</label>
                                <select id="analogia_natureza" class="form-control" style="font-size: 0.9rem;">
                                    <option value="">Selecione a natureza...</option>
                                    <option value="Leve">Leve</option>
                                    <option value="Média">Média</option>
                                    <option value="Grave">Grave</option>
                                </select>
                            </div>
                            <input type="text" id="analogia_search" placeholder="Primeiro selecione a natureza da analogia..." autocomplete="off" disabled>
                            <div id="analogia_dropdown" class="dropdown-infracao" style="display: none;">
                                <!-- Opções serão carregadas via JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botão para adicionar nova transgressão -->
                    <div id="botao_adicionar_transgressao" style="display: none; margin-top: 10px;">
                        <button type="button" id="btnAdicionarTransgressao" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">
                            <i class="fas fa-plus"></i> Adicionar outra transgressão
                        </button>
                    </div>
                    
                    <small class="form-help">Digite parte do texto da transgressão para filtrar</small>
                </div>
                
                <div class="form-group" id="group_natureza_procedimento" style="display: none;">
                    <label for="natureza_procedimento">Natureza Principal Apurada (Procedimento) *</label>
                    <select id="natureza_procedimento" required>
                        <option value="">Selecione...</option>
                        <option value="Sinistro de trânsito com Viatura Policial Militar">Sinistro de trânsito com Viatura Policial Militar</option>
                        <option value="Sinistro de trânsito com veículo oficial, exceto viatura policial militar">Sinistro de trânsito com veículo oficial, exceto viatura policial militar</option>
                        <option value="Agressão policial">Agressão policial</option>
                        <option value="Lesão Corporal">Lesão Corporal</option>
                        <option value="Amparo de PM lesionado durante ato de serviço">Amparo de PM lesionado durante ato de serviço</option>
                    </select>
                </div>

                <!-- Resumo dos Fatos -->
                <div class="form-group">
                    <label for="resumo_fatos">Resumo dos Fatos (opcional)</label>
                    <textarea id="resumo_fatos" rows="4"></textarea>
                </div>

                <!-- Conclusão -->
                <div class="form-group">
                    <div class="checkbox-container">
                        <input type="checkbox" id="concluido">
                        <label for="concluido" id="label_concluido">
                            Procedimento concluído
                        </label>
                    </div>
                </div>

                <!-- Campo de data de conclusão (condicional) -->
                <div class="form-group" id="group_data_conclusao" style="display: none;">
                    <label for="data_conclusao">Data de Conclusão *</label>
                    <input type="date" id="data_conclusao" required>
                </div>

                <!-- Campo de solução final (condicional) -->
                <div class="form-group" id="group_solucao_final" style="display: none;">
                    <label for="solucao_final">Solução Final *</label>
                    <textarea id="solucao_final" rows="4" placeholder="Descreva a solução final adotada para este processo/procedimento..." required></textarea>
                </div>

                <button type="submit" class="btn-primary" id="btnCadastrar">
                    <i class="fas fa-folder-plus"></i>
                    Registrar
                </button>
                
                <button type="button" onclick="voltarParaListagem()" class="btn-secondary-form">
                    <i class="fas fa-arrow-left"></i>
                    Voltar
                </button>
            </form>
        </div>
        </div>
    </div>
    
    <script src="static/js/procedure_form.js"></script>
    <!-- Modal de busca de usuário -->
    <style>
        .modal-busca-usuario {
            display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;
            background:rgba(0,0,0,0.35); z-index:9999; align-items:center; justify-content:center;
        }
        .modal-busca-usuario .modal-content-busca {
            background:#fff; border-radius:16px; max-width:480px; width:96%; padding:32px 24px;
            box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative; animation:fadeInModal 0.3s;
        }
        @keyframes fadeInModal {
            from { opacity:0; transform:scale(0.98); }
            to { opacity:1; transform:scale(1); }
        }
        .modal-busca-usuario h3 {
            margin-bottom:18px; color:#222; font-size:1.25rem; font-weight:600;
        }
        .modal-busca-usuario #btnFecharModalBusca {
            position:absolute; top:14px; right:14px; background:none; border:none; font-size:22px; cursor:pointer; color:#aaa; transition:color 0.2s;
        }
        .modal-busca-usuario #btnFecharModalBusca:hover {
            color:#e74c3c;
        }
        .modal-busca-usuario #inputBuscaUsuario {
            flex:1; padding:10px; border-radius:8px; border:1px solid #d1d5db; font-size:1rem;
        }
        .modal-busca-usuario #btnExecutarBuscaUsuario {
            padding:10px 20px; border-radius:8px; border:none; background:#007bff; color:#fff; cursor:pointer; font-weight:500; font-size:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.07);
            transition:background 0.2s;
        }
        .modal-busca-usuario #btnExecutarBuscaUsuario:hover {
            background:#0056b3;
        }
        .modal-busca-usuario #resultadosBuscaUsuario {
            max-height:320px; overflow-y:auto; margin-top:8px;
        }
        .modal-busca-usuario .resultado-usuario {
            display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid #f0f0f0;
        }
        .modal-busca-usuario .resultado-usuario:last-child {
            border-bottom:none;
        }
        .modal-busca-usuario .resultado-usuario .info {
            font-size:1rem;
        }
        .modal-busca-usuario .resultado-usuario .info span {
            margin-right:10px;
        }
        .modal-busca-usuario .btnEscolherUsuario {
            background:none; border:none; color:#28a745; font-size:22px; cursor:pointer; transition:color 0.2s;
        }
        .modal-busca-usuario .btnEscolherUsuario:hover {
            color:#218838;
        }
        
        /* Estilos para o dropdown de infrações */
        .dropdown-infracao {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .dropdown-infracao .item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
            line-height: 1.3;
        }
        
        .dropdown-infracao .item:last-child {
            border-bottom: none;
        }
        
        .dropdown-infracao .item:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown-infracao .item.selected {
            background-color: #e3f2fd;
        }
        
        .dropdown-infracao .inciso {
            font-weight: bold;
            color: #1976d2;
        }
        
        .dropdown-infracao .texto {
            color: #666;
            margin-top: 2px;
        }
        
        #infracao_input {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px 8px 0 0;
            width: 100%;
            font-size: 1rem;
        }
        
        #infracao_input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
    </style>
    
    <!-- Modal de Feedback -->
    <div id="modalFeedback" class="modal-feedback">
        <div class="modal-content">
            <div class="modal-header">
                <div id="modalIcon"></div>
            </div>
            <div class="modal-body">
                <div id="modalMessage">Mensagem</div>
            </div>
            <div class="modal-actions">
                <button id="modalCloseBtn" class="btn-primary">OK</button>
            </div>
        </div>
    </div>
    
    <div id="modalBuscaUsuario" class="modal-busca-usuario">
        <div class="modal-content-busca">
            <button id="btnFecharModalBusca" title="Fechar"><i class="fas fa-times"></i></button>
            <h3>Buscar Usuário</h3>
            <div style="display:flex; gap:10px; margin-bottom:16px;">
                <input type="text" id="inputBuscaUsuario" placeholder="Nome ou matrícula">
                <button id="btnExecutarBuscaUsuario" class="btn-primary">Buscar</button>
            </div>
            <div id="resultadosBuscaUsuario"></div>
        </div>
    </div>
</body>
</html>