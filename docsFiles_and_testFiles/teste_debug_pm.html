<!DOCTYPE html>
<html>
<head>
    <title>Teste Debug PM M√∫ltiplos</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .resultado { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .erro { background: #ffebee; color: #c62828; }
        .sucesso { background: #e8f5e8; color: #2e7d32; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>Teste Debug - PM M√∫ltiplos</h1>
    <p>Este teste ir√° verificar a funcionalidade dos campos de PM m√∫ltiplos.</p>
    
    <button onclick="executarTeste()">Executar Teste</button>
    <button onclick="limparResultados()">Limpar</button>
    
    <div id="resultados"></div>

    <script>
        function log(mensagem, tipo = 'info') {
            const div = document.createElement('div');
            div.className = `resultado ${tipo}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${mensagem}`;
            document.getElementById('resultados').appendChild(div);
            console.log(mensagem);
        }

        function limparResultados() {
            document.getElementById('resultados').innerHTML = '';
        }

        function executarTeste() {
            limparResultados();
            log('=== INICIANDO TESTE DE DEBUG ===');
            
            try {
                // 1. Verificar se estamos na p√°gina certa
                const currentUrl = window.location.href;
                log(`URL atual: ${currentUrl}`);
                
                if (!currentUrl.includes('procedure_form.html') && !currentUrl.includes('8080')) {
                    log('‚ö†Ô∏è Este teste deve ser executado na p√°gina do formul√°rio de procedimentos!', 'erro');
                    log('Abra uma nova aba e navegue para: http://localhost:8080/web/procedure_form.html');
                    return;
                }

                // 2. Verificar se o container existe
                const container = document.getElementById('container_pms_envolvidos');
                if (!container) {
                    log('‚ùå Container container_pms_envolvidos n√£o encontrado!', 'erro');
                    return;
                }
                log('‚úÖ Container encontrado', 'sucesso');

                // 3. Verificar quantos PMs existem
                const pmsItems = container.querySelectorAll('.pm-item');
                log(`üìä Total de PMs encontrados: ${pmsItems.length}`);

                if (pmsItems.length === 0) {
                    log('‚ö†Ô∏è Nenhum PM encontrado. Adicione pelo menos um PM primeiro!', 'erro');
                    log('Instru√ß√µes: Selecione "Procedimento" ‚Üí Tipo ‚Üí Status do PM ‚Üí Clique em "Adicionar PM"');
                    return;
                }

                // 4. Verificar a estrutura do primeiro PM
                const primeiroItem = pmsItems[0];
                log(`üîç HTML do primeiro PM: ${primeiroItem.innerHTML.substring(0, 200)}...`);

                const pmIdField = primeiroItem.querySelector('[data-field="pm_id"]');
                const nomeField = primeiroItem.querySelector('[data-field="nome"]');

                if (!pmIdField) {
                    log('‚ùå Campo pm_id n√£o encontrado!', 'erro');
                    return;
                }
                if (!nomeField) {
                    log('‚ùå Campo nome n√£o encontrado!', 'erro');
                    return;
                }

                log('‚úÖ Campos encontrados corretamente', 'sucesso');

                // 5. Verificar valores atuais
                log(`üìã Valores atuais - PM ID: "${pmIdField.value}", Nome: "${nomeField.value}"`);

                // 6. Testar preenchimento manual
                log('üß™ Testando preenchimento manual...');
                pmIdField.value = 'teste-id-debug-123';
                nomeField.value = 'TESTE DEBUG MANUAL';

                log(`‚úÖ Preenchimento manual realizado - PM ID: "${pmIdField.value}", Nome: "${nomeField.value}"`, 'sucesso');

                // 7. Verificar se a fun√ß√£o obterPmsEnvolvidos existe
                if (typeof obterPmsEnvolvidos !== 'function') {
                    log('‚ùå Fun√ß√£o obterPmsEnvolvidos n√£o encontrada!', 'erro');
                    return;
                }

                // 8. Testar a fun√ß√£o
                log('üß™ Testando fun√ß√£o obterPmsEnvolvidos...');
                const resultado = obterPmsEnvolvidos();
                log(`üìä Resultado da fun√ß√£o: ${JSON.stringify(resultado, null, 2)}`);

                if (resultado.length > 0) {
                    log('‚úÖ Sucesso! A fun√ß√£o retornou dados', 'sucesso');
                } else {
                    log('‚ö†Ô∏è A fun√ß√£o retornou array vazio', 'erro');
                }

                // 9. Verificar status global
                const statusPm = document.getElementById('status_pm');
                if (statusPm) {
                    log(`üìã Status PM selecionado: "${statusPm.value}"`);
                    if (!statusPm.value) {
                        log('‚ö†Ô∏è Nenhum status de PM selecionado! Selecione um status primeiro.', 'erro');
                    }
                }

                log('=== TESTE CONCLU√çDO ===');

            } catch (error) {
                log(`‚ùå Erro durante o teste: ${error.message}`, 'erro');
                log(`Stack trace: ${error.stack}`, 'erro');
            }
        }

        // Auto-executar se estivermos na p√°gina certa
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (window.location.href.includes('procedure_form.html') || window.location.href.includes('8080')) {
                    log('üöÄ P√°gina detectada automaticamente. Execute o teste quando estiver pronto.');
                }
            }, 1000);
        });
    </script>
</body>
</html>
